---
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-xds
data:
  cds.yaml: |
    resources:
    - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: local_service
      connect_timeout: 0.25s
      type: logical_dns
      load_assignment:
        cluster_name: local_service
        endpoints:
        - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: 127.0.0.1
                  port_value: 8081
    - "@type": type.googleapis.com/envoy.config.cluster.v3.Cluster
      name: alternate_service
      connect_timeout: 0.25s
      type: logical_dns
      load_assignment:
        cluster_name: alternate_service
        endpoints:
        - lb_endpoints:
          - endpoint:
              address:
                socket_address:
                  address: loot-data.jacob
                  port_value: 8081
  lds.yaml: |
    resources:
    - "@type": type.googleapis.com/envoy.config.listener.v3.Listener
      name: listener_0
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8000
      filter_chains:
      - filters:
          name: envoy.http_connection_manager
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
            codec_type: auto
            stat_prefix: ingress_http
            http_filters:
            - name: envoy.router
            route_config:
              name: local_route
              virtual_hosts:
              - name: local_service
                domains:
                - "*"
                routes:
                - match:
                    prefix: "/"
                    headers:
                      - name: "x-okteto-divert"
                        exact_match: "loot-data:ramiro:1234"
                  route:
                    cluster: alternate_service
                - match:
                    prefix: "/"
                    headers:
                      - name: "x-okteto-divert"
                        exact_match: "loot-data:jacob:1234"
                  route:
                    cluster: alternate_service
                - match:
                    prefix: "/"
                  route:
                    cluster: local_service
